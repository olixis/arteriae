var querystring=require("querystring"),request=require("request"),cheerio=require("cheerio"),restify=require("restify"),emitter=require("events"),eventEmitter=new emitter.EventEmitter,MAXRESULTS=10,server=restify.createServer();server.use(restify.queryParser()),module.exports.feedServer=function(){server.get("/:keyword",function(req,res,next){feed(req.params.keyword),eventEmitter.once("retorno",function(retorno){return res.header("Access-Control-Allow-Origin","*"),res.send(retorno),next()})}),server.on("listening",function(){console.log("server running!")}),server.listen(7171)};var feed=function(word,l){if(!Array.isArray(l)&&void 0!==l)return console.log("por favor passe um array"),!1;l!==[]&&(links=l),links=["http://www.globo.com/","http://atarde.uol.com.br/","http://www.estadao.com.br/"];var teste=0,final=[];for(i=links.length-1;i>=0;i--)findHeadlines(links[i],word.toLowerCase(),function(r,url){final.push({url:url,keyword:word,manchetes:r}),teste++,console.log(100*(teste/links.length)+"%"),teste===links.length&&(console.log("Concluído!"),console.log(final),eventEmitter.emit("retorno",final))})},findHeadlines=function findHeadlines(url,word,cb){request(url,{timeout:1e3},function(error,response,body){if(error||200!=response.statusCode)console.log(error),cb([],url);else{$=cheerio.load(body),texto=[];var retorno=[];b=$("body").text().toLowerCase(),c=b.replace(/\s+/g," "),texto=c.split("¬"),keywords=word.split(" "),texto=Array.from(new Set(texto));for(var i=texto.length-1;i>=0;i--){for(var o=keywords.length-1;o>=0;o--)-1!==texto[i].search(keywords[o])&&100>texto[i].length&&keywords[o].length>2&&retorno.push(texto[i]);-1!==texto[i].search(word)&&100>texto[i].length&&retorno.push(texto[i])}retorno=Array.from(new Set(retorno)),cb(retorno,url)}})};